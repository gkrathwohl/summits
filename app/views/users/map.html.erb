
<!--mapbox.js-->
<script src='https://api.mapbox.com/mapbox.js/v2.4.0/mapbox.js'></script>
<link href='https://api.mapbox.com/mapbox.js/v2.4.0/mapbox.css' rel='stylesheet' />

  <link rel="stylesheet" href="http://libs.cartocdn.com/cartodb.js/v3/3.15/themes/css/cartodb.css" />
    <script src="http://libs.cartocdn.com/cartodb.js/v3/3.15/cartodb.js"></script>

<style>
  #map { 
    position:absolute; top:0; bottom:0; width:100%; 
  }

  .leaflet-top.leaflet-right{
    padding-top: 50px;
  }
</style>
<input type="checkbox">
<div id='map'></div>
<script src="https://ajax.googleapis.com/ajax/libs/jquery/2.2.2/jquery.min.js"></script>
<script>
  
        $(document).ready(function () {
            $('#map-nav').addClass('active');
        });

var a;

  setTimeout(function(){
    
    L.mapbox.accessToken = 'pk.eyJ1IjoiZ2tyYXRod29obCIsImEiOiJ5bXlHNXJJIn0.gjNMPWKFNso_Z5EmEjsFGA';
    var map = L.mapbox.map('map', null, {
        zoomControl: false
    })
    
    <% if @start_location %>
      map.setView(<%= @start_location %>, 13)
    <% else %>
      map.setView([37.8, -96], 4);
    <% end %>

    var layers = {
        Streets: L.mapbox.tileLayer('mapbox.streets'),
        Outdoors: L.mapbox.tileLayer('mapbox.outdoors'),
        Satellite: L.mapbox.tileLayer('mapbox.satellite'),
        Strava: L.tileLayer('http://globalheat.strava.com/tiles/both/color7/{z}/{x}/{y}.png')
    };

    map.addLayer(layers.Outdoors);
    //map.addLayer(L.tileLayer('http://ashbu.cartocdn.com/gkrathwohl/api/v1/map/251a910f9605dea3bacfa59daa15bde2:1466311017205/{z}/{x}/{y}.png'));

    //map.addLayer(layers.Strava);

    L.control.layers({}, {'Strava Heatmap': layers.Strava}).addTo(map);

    function showActivity(id){
      console.log(id);
      $.ajax("/users/get_activity/" + id, {
        success: function(data) {
          console.log(data);

          var polyline = L.polyline(data,
            {
                color: 'red',
                weight: 2,
                opacity: .7,
                lineJoin: 'round'
            }
            ).addTo(map);
        },
        error: function() {
          console.log("error");
        }
      });
    }

    // get data
    $.ajax("/users/get_summits/<%= @user.id %>", {
      success: function(data) {
        $.each(data, function(i, summit){
          var popup = $("<div><h2 class='text-center'>"+summit.summit+"</h2><p>Elevation: "+ summit.osm_summit_elevation +" ft</p><p><a href=https://www.strava.com/activities/"+ summit.activity_id +" target='_blank'>View on Strava</a></p></div>")
          var link = $('<p><a href="#" class="speciallink">Show Activity</a></p>').click(function(){showActivity(summit.activity_id)});
          marker = new L.marker([summit.osm_summit_lat, summit.osm_summit_lon])
            .bindPopup(popup.append(link)[0])
            .addTo(map);
        });        

      },
      error: function() {
        console.log("error");
      }
   });




    //layers.Strava.setZIndex(2).addTo(map);
    
    // add strava toggle
    // document.getElementById('checkbox1').onclick = function (e) {
    //   if (map.hasLayer(layers.Strava)) {
    //       map.removeLayer(layers.Strava);
    //   } else {
    //     layers.Strava.setZIndex(2).addTo(map);
    //   }
    // };
    
    // add basemap toggle
    // var options = document.getElementsByName('options');
    // options[0].onchange = toggleBaseMap;
    // options[1].onchange = toggleBaseMap;
    
    // // basemap toggle function
    // function toggleBaseMap(){ 
    //   var options = document.getElementsByName('options');
    //   if(options[1].checked){
    //     map.removeLayer(layers.Outdoors)
    //     map.addLayer(layers.Satellite);
    //   }else{         
    //     map.removeLayer(layers.Satellite);
    //     map.addLayer(layers.Outdoors);
    //   }
    // }    
    
    
    // L.control.locate({
    //   icon: 'fa fa-map-marker',
    //   iconElementTag: 'span',
    //   iconLoading: 'fa fa-spinner fa-spin',
    //   drawCircle: false,
    //   //follow: true,
    //   position: 'topright',
    //   locateOptions: {
    //     maxZoom: 14
    //   }
    // }).addTo(map).start();  
    
    // // Initialize the geocoder control and add it to the map.
    // var geocoderControl = L.mapbox.geocoderControl('mapbox.places', { position: 'topright' });
    // geocoderControl.addTo(map);


  
  }, 100);

</script>